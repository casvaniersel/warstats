<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <title>WarStats</title>
</head>

<body>
  <main>
    <h1 id="name"></h1>
    <p>BR KD: <b id="kd"></b></p>
    <p>BR Wins: <b id="wins"></b></p>
    <h1>Laatste match:</h1>
    <p><b id="lastmatch"></b></p>
  </main>
</body>

<script>
  (
    async function () {
      try {
        const user = getUserNameFromUrl();
        setUserName(user)
        setPlayerDatafor(user)
        setMatchDataFor(user)
      } catch (error) {
        console.log(error);
      }
    })();

  async function getPlayerDatafor(user) {
    let response = await fetch("/api/playerdata?name=" + user);
    let playerdata = JSON.parse(await response.text());
    return playerdata;
  }

  async function getMatchDataFor(user) {
    let response = await fetch("/api/matchdataofplayer?name=" + user);
    let matchdata = JSON.parse(await response.text());
    return matchdata;
  }

  async function setMatchDataFor(user) {
    let data = await getMatchDataFor(user);
    let lastmatch = data.matches[0];
    document.querySelector("#lastmatch").innerHTML =
      '<div style="display:block">MatchId: ' + lastmatch.matchID + '<br>'
      + 'Date Time: ' + formatDate(epochTimestampToJavascriptDate(lastmatch.utcStartSeconds)) + '<br>'
      + 'Player: ' + lastmatch.player.username + '<br>'
      + 'Kills: ' + lastmatch.playerStats.kills + '<br>'
      + 'Placement: ' + lastmatch.playerStats.teamPlacement + '</div>'
  }

  async function setPlayerDatafor(user) {
    let playerdata = await getPlayerDatafor(user);
    console.log(playerdata);
    document.querySelector("#kd").innerHTML = playerdata.br.kdRatio;
    document.querySelector("#wins").innerHTML = playerdata.br.wins;
  }

  function setUserName(user) {
    document.querySelector("#name").innerHTML = user.toUpperCase();
  }

  function getUserNameFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('user');
  }

  function epochTimestampToJavascriptDate(timestampInMillisecond) {
    return new Date(millisecondsToSeconds(timestampInMillisecond));
  }

  function millisecondsToSeconds(milliseconds) {
    let seconds = milliseconds * 1000;
    return seconds;
  }

  function formatDate(date) {
    let dateFormatted = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
    return dateFormatted;
  }

</script>

</html>